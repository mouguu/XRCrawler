# 使用 Node 22 Debian Slim 版本 (Prisma 7 官方推荐，避开 Alpine musl 问题)
FROM node:22-slim

# 安装构建工具 (WASM 编译需要 python3 和 build-essential)
RUN apt-get update && apt-get install -y \
  python3 \
  make \
  g++ \
  curl \
  && rm -rf /var/lib/apt/lists/*

# 安装 Rust (用于 WASM 编译)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN cargo install wasm-pack

WORKDIR /app

# 1. 复制依赖定义
COPY package.json ./

# 2. 使用 npm 安装依赖 (跳过 postinstall WASM 构建)
RUN npm install --ignore-scripts

# 3. 生成 Prisma Client (关键步骤：在 npm install 之后，源码复制之前)
COPY prisma ./prisma
RUN npx prisma generate

# 4. 复制其余源码（包括 WASM 源码）
COPY . .

# 5. 手动构建 WASM 模块
RUN npm run build:wasm:all

# 6. 构建后端 TypeScript
RUN npm run build

# 7. 构建前端
COPY frontend/package.json ./frontend/
RUN cd frontend && npm install
COPY frontend ./frontend
RUN cd frontend && npm run build

# 暴露端口
EXPOSE 5001

# 启动命令
CMD ["node", "dist/cmd/start-server.js"]
